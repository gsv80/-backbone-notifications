<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./style.css">
    <title>Notifications with Backbone.js</title>    
</head>
<body>
    <!-- ========== -->
        <!-- HTML -->
    <!-- ========== -->
    <section id="header"></section>
    <section class="main__section"></section>
    
    <!-- ========= -->
    <!-- Templates -->
    <!-- ========= -->

    <script type="text/template" id="header-template">
        <ul id="header__menu">
            <li class="menu-item"><a href="#">Logo</a></li>
            <li class="menu-item notifies">
                <div class="notifies-menu">
                    <img src="./assets/bell.png" alt="notifications bell" id="notifyBell">
                    <div id="newNotifies" class="qty__text">newNotifies...</div>
                </div>
                <ul id="notifies-list" class="hide"></ul>
            </li>
            <li class="menu-item">User's name</li>
        </ul> 
    </script>

    <script type="text/template" id="notify-template">
        <div class="view" >
            <h4><%- title %></h4>
            <p><%- notify %></p>
            <button class="destroy">read/remove</button>
        </div>
    </script> 
    <!-- ========= --> 
    <!-- Libraries -->
    <!-- ========= -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.2/underscore-min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.4.1/backbone-min.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone-localstorage.js/1.1.9/backbone.localStorage-min.js" type="text/javascript"></script>  
    
    <!-- =============== -->
    <!-- Javascript code --> 
    <!-- =============== -->
    <script type="text/javascript">
        // your JS code goes here
        'use strict';

        let app = {}; // create namespace for our app 
    // ---------------
    // -- Models--
    // ---------------
    

    const Notify = Backbone.Model.extend({
        defaults: {
            title: '',
            notify: '',
            unread : true,
        },   
        toggle: function(){
            this.save({unread : !this.get('unread')});
        }
    });
      
    
    // -- Collections --

    const Notifies = Backbone.Collection.extend({
        model: Notify,
        localStorage: new Store("backbone-notifies"),
        unread: function(){
            return this.where({unread: true})
        }, 
    });
 
    // instance of the Collection
    let notifies = new Notifies();

    let templates = [
            {title : "sender 3", notify: "text 2"},
            {title : "sender 1", notify: "text 1"},
            {title : "sender 3", notify: "text 3"},
            {title : "sender 3", notify: "text 4"},
            {title : "sender 2", notify: "text 5"},
            {title : "sender 2", notify: "text 6"},
            {title : "sender 1", notify: "text 7"},
            {title : "sender 1", notify: "text 8"},
            {title : "sender 4", notify: "text 9"},
            {title : "sender 5", notify: "text 10"},
    ];
           
    // --------------
    //  -- Views --
    // --------------   

    // -- renders individual notify

    const NotifyView = Backbone.View.extend({
        tagName: "li",      
        template: _.template($('#notify-template').html()),

        initialize: function(){ 
            this.listenTo(this.model, 'destroy', this.remove);
        },
        render: function(){
            this.$el.html(this.template(this.model.toJSON()));
            return this;
        },
        events: {
            'click .destroy' : 'destroy',
        },
        
        destroy: function(){
            this.model.destroy();
        },
                       
    });

    const NotifyListView = Backbone.View.extend({
        
        render: function(){
            let self = this;
            this.model.each(function(notify){
                let notifyView = new NotifyView( {model: notify} );
                self.$el.append(notifyView.render().$el)
            });
            return this;
        },

        initialize : function(){
            this.listenTo(notifies, 'add', this.refresh);
            
        },
        refresh: function(){
           console.log('#### refresh'); 
           $('#notifies-list').html('');
           this.render();
        },
    
    });   

    const NotifiesView = Backbone.View.extend({

        template: _.template($('#header-template').html()),

        render: function(){
            this.$('#newNotifies').html((notifies.unread().length)==0 ? '': notifies.unread().length);
            return this;
        },
        
        initialize: function(){
            this.$el.html(this.template());
            this.listenTo(notifies, 'all', this.render);
                  
        },
        
        events: { 
            'click #notifyBell' : 'toggleNotifies', 
        },
        
        toggleNotifies: function(){
            console.log('bell clicked');
            tgl=!tgl;
            if (tgl){
                $('#notifies-list').removeClass('hide');
            } else  $('#notifies-list').addClass('hide');
            this.render();
        },

        
        

    });
    
    let tgl=false;
    

    let notifiesView = new NotifiesView({ el: "#header" });
    let notifyListView = new NotifyListView({ el: "#notifies-list", model: notifies });

        
    notifies.create(templates[Math.floor(Math.random()*10)]);
    notifies.create(templates[Math.floor(Math.random()*10)]);
    for(let i=3000; i<=10000; i+=1000){
        setTimeout(() => { 
            notifies.add(templates[Math.floor(Math.random()*10)]);
            console.log("#### notify was added ", notifies.at(notifies.length-1), "#### notifies length: ", notifies.length)
        }, i);
        
    }  
    
    
    notifyListView.render();

    //  console.log(notifies);   

</script>

    
</body>
</html>